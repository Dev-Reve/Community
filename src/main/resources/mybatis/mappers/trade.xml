<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!-- DAO에서 아래 mapper태그 내부에 접근하기 위해 mapper태그에 namespace를 설정 -->
  <!-- DAO에서 member관련 sql문을 작성 또는 호출을 위해서는 mapper.member를 호출하여야 함 -->
<mapper namespace="mapper.trade">
	<!-- member관련 DB에서 조회해온 결과를 담을 Map을 생성하여 id값을 memResult로 저장 -->
	<!-- 이후 조회해온 resultMap에 VO들을 담기 위해서  resultMap에 memResult를 작성하거나
		 resultType에 memberVO를 작성하여 VO빈에 저장하면 됨  -->
	<resultMap id="tradeResult" type="tradeVO">
		<result property="no" column="no"/>
		<result property="readCount" column="readCount"/>
		<result property="price" column="price"/>
		<result property="sellStat" column="sellStat"/>
		<result property="title" column="title"/>
		<result property="content" column="content"/>
		<result property="nickname" column="nickname"/>
		<result property="writeDate" column="writeDate"/>
		<result property="category" column="category"/>
	    <result property="fileNames" column="fileName" typeHandler="com.spring.community.trade.utils.OracleTypeHandler"/>
	</resultMap>
	
	<select id="selectAllTrades" resultMap="tradeResult" parameterType="java.util.HashMap">
			<![CDATA[
		    	SELECT *  
				FROM ( 
					SELECT ROWNUM AS rn, t.*
					FROM ( 
						SELECT *
						FROM trade
						ORDER BY writeDate desc
					) t
					WHERE
		    ]]>
		    <if test="category != null">
		    	<![CDATA[
		    		category=#{category} and 
		    	]]>
		    </if>
		    <![CDATA[
		    	 	ROWNUM <= #{endRow}
					)
				WHERE rn >= #{startRow}
		    ]]>
	  </select>
	
	<select id="getTradeCount" resultType="int" parameterType="String">
		<![CDATA[
			select count(*) from trade
		]]>
		<if test="category != null"> 
			<![CDATA[
				WHERE category=#{category}
			]]>
		</if>
	</select>
	
	<insert id="insertTrade" parameterType="java.util.HashMap">
		<![CDATA[
			INSERT INTO trade(no, title, content, category, price, nickName, fileName)
			values(trade_no.nextval, #{title}, #{content}, #{category}, #{price}, #{nickname}, StringArray(
		]]>
		<foreach collection="fileList" item="fileName" separator=", " close="))">
			#{fileName}
		</foreach>
	</insert>
	
	
	<select id="getNewTradeNo" resultType="int">
		<![CDATA[
			SELECT MAX(no) FROM trade
		]]>
	</select>
	
	<select id="selectTradeDetail" resultMap="tradeResult" parameterType="int">
		<![CDATA[
	        SELECT no, title, content, category, nickName, sellStat, price,
	               CAST(MULTISET (SELECT column_value FROM TABLE(fileName)) AS sys.odcivarchar2list) AS fileName
	        FROM trade WHERE no = #{no}
 	   ]]>
	</select>
	
	<delete id="delTrade" parameterType="int">
		<![CDATA[
			DELETE FROM trade WHERE no=#{no}
		]]>
	</delete>
	
	<update id="updateTrade" parameterType="java.util.HashMap">
		<![CDATA[
			UPDATE trade SET category=#{category}, title=#{title}, content=#{content}, price=#{price}, fileName=StringArray(
		]]>
		<foreach collection="fileList" item="fileName" separator=", " close=")">
			#{fileName}
		</foreach>
		WHERE no = #{no}
	</update>
</mapper>